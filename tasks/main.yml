---
# tasks file for apache2

- name: Install required packages
  package: name={{apache2_packages_default | union(apache2_packages)}}

- include_tasks: "{{ansible_os_family | lower}}.yml"

- name: Configure listen ports
  template:
    src: ports.conf.j2
    dest: "{{apache2_config_path}}/ports.conf"
  notify: restart apache2

- name: Create default HTTP site
  template:
    src: default.conf
    dest: "{{apache2_default_host_path}}"
  when: apache2_create_default

- name: Create default HTTPS site
  template:
    src: default-ssl.conf
    dest: "{{apache2_default_ssl_host_path}}"
  when: apache2_create_default_ssl

- name: Create document root
  file:
    path: "{{apache2_base_path}}"
    state: directory
    owner: "{{apache2_user}}"
    group: "{{apache2_group}}"
  when: apache2_create_default or apache2_create_default_ssl

- name: Create empty default page
  file:
    path: "{{apache2_base_path}}/index.html"
    owner: "{{apache2_user}}"
    group: "{{apache2_group}}"
    state: touch
  changed_when: false
  when: apache2_create_default or apache2_create_default_ssl

- name: Enable default HTTP site
  file:
    src: "{{apache2_default_host_path}}"
    dest: "{{apache2_sites_enabled_path}}/000-default.conf"
    state: link
  when: apache2_create_default

- name: Enable default HTTPS site
  file:
    src: "{{apache2_default_ssl_host_path}}"
    dest: "{{apache2_sites_enabled_path}}/000-default_ssl.conf"
    state: link
  when: apache2_create_default_ssl

- name: Enable Apache2 service
  service:
    name: "{{apache2_service}}"
    enabled: true
